{
  "version": 3,
  "sources": ["../../src/notification/notification_manager.ts"],
  "sourcesContent": ["import { SamartHomeHandyBis } from \"../main\";\nimport { Events, StateChangeEvent } from \"../listener/listener\";\n\nimport { DataPack, NotificationPack } from \"../server/datapacks\";\nimport { Client } from \"../server/client\";\n\nexport class NotificationManager {\n    adapter: SamartHomeHandyBis;\n    backlog: { [deviceID: string]: string[] } = {};\n    constructor(adapter: SamartHomeHandyBis) {\n        this.adapter = adapter;\n        this.init();\n    }\n\n    private init(): void {\n        this.adapter.listener.on(Events.StateChange, this.onStateChange.bind(this));\n    }\n\n    private onStateChange(event: StateChangeEvent): void {\n        const match: RegExpMatchArray | null = event.objectID.match(\"(hiob.\\\\d*.devices.)(.*)(.sendNotification)\");\n        if (match && match[2] && !event.ack) {\n            const deviceID = match[2];\n            const client = this.adapter.server?.getClient(deviceID);\n            //Check if client is connected\n            if (client?.isConnected) {\n                this.sendNotificationLocal(client, event.value);\n            } else {\n                //Store to backlog\n                if (this.backlog[deviceID]) {\n                    this.backlog[deviceID].push(event.value);\n                } else {\n                    this.backlog[deviceID] = [event.value];\n                }\n            }\n            this.adapter.setState(event.objectID, { ack: true });\n        }\n    }\n\n    public sendNotificationLocal(client: Client, notification: string): void {\n        client.sendMSG(new NotificationPack(false, notification, new Date()).toJSON());\n    }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,sBAAyC;AAEzC,uBAA2C;AAGpC,MAAM,oBAAoB;AAAA,EAG7B,YAAY,SAA6B;AADzC,mBAA4C,CAAC;AAEzC,SAAK,UAAU;AACf,SAAK,KAAK;AAAA,EACd;AAAA,EAEQ,OAAa;AACjB,SAAK,QAAQ,SAAS,GAAG,uBAAO,aAAa,KAAK,cAAc,KAAK,IAAI,CAAC;AAAA,EAC9E;AAAA,EAEQ,cAAc,OAA+B;AAlBzD;AAmBQ,UAAM,QAAiC,MAAM,SAAS,MAAM,6CAA6C;AACzG,QAAI,SAAS,MAAM,MAAM,CAAC,MAAM,KAAK;AACjC,YAAM,WAAW,MAAM;AACvB,YAAM,UAAS,UAAK,QAAQ,WAAb,mBAAqB,UAAU;AAE9C,UAAI,iCAAQ,aAAa;AACrB,aAAK,sBAAsB,QAAQ,MAAM,KAAK;AAAA,MAClD,OAAO;AAEH,YAAI,KAAK,QAAQ,WAAW;AACxB,eAAK,QAAQ,UAAU,KAAK,MAAM,KAAK;AAAA,QAC3C,OAAO;AACH,eAAK,QAAQ,YAAY,CAAC,MAAM,KAAK;AAAA,QACzC;AAAA,MACJ;AACA,WAAK,QAAQ,SAAS,MAAM,UAAU,EAAE,KAAK,KAAK,CAAC;AAAA,IACvD;AAAA,EACJ;AAAA,EAEO,sBAAsB,QAAgB,cAA4B;AACrE,WAAO,QAAQ,IAAI,kCAAiB,OAAO,cAAc,IAAI,KAAK,CAAC,EAAE,OAAO,CAAC;AAAA,EACjF;AACJ;",
  "names": []
}
